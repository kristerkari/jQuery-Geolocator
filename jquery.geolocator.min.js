(function(a,b,c,d){function g(b,c){return this.settings=c,this.el=c.locationsElem||b,this.addressArr=[],this.$el=a(this.el),this.$recheckElem=a(c.recheckElem),this.$checkElem=a(c.checkElem),this.$notificationElem=a(c.notificationElem),this.$geodataElem=a(c.geodataElem),this.prepare(),this}"use strict";var e="jquery-geolocator",f={manualCheck:!1,sorting:!0,debugMode:!1,enableHighAccuracy:!1,timeout:6e3,maximumAge:6e4,apiKey:null,locationsElem:null,geodataElem:"#geodata",recheckElem:"#recheck",checkElem:"#check",notificationElem:".notification",distanceElem:".distance",geoAdrElem:".adr",mapsLinkElem:".maps-link",listParentElem:"ul",listElem:"li",notificationStyle:"show",distanceBigStr:"miles",distanceSmallStr:"meters",distanceUnknownStr:"unknown",notFoundStr:"Could not get your location",mapsLinkStr:"Show directions"};g.prototype={constructor:g,prepare:function(){var a=this,b=a.settings,c=a.$checkElem;a.$lists=a.$el.children(b.listParentElem),a.listLength=a.$lists.children(b.listElem).length,a.ownLatLng=null,a.tCount=0,a.lCount=0,this.html5Geo=!1,a.addressArr.length=0,b.manualCheck&&c.length?c.show().click(function(b){b.preventDefault(),a.init()}):a.init()},init:function(){var a=this,c=b.google,d=a.$notificationElem,e=a.$recheckElem,f=a.settings.notificationStyle;if(typeof c=="undefined"||typeof c.load=="undefined"||typeof c.maps=="undefined"){a.loadGoogleAPI();return}a.google=c,a.googleMaps=c.maps,d.length&&!d.is(":visible")&&(f==="fade"?d.fadeIn(300):f==="slide"?d.slideDown(300):d.show()),e.length&&e.is(":visible")&&e.unbind("click").hide(),a.getGeolocation()},loadGoogleAPI:function(){var c=this,d=b.google;if(typeof d!="undefined"&&typeof d.load!="undefined"&&typeof d.maps=="undefined"){d.load("maps","3",{other_params:"sensor=true",callback:function(){c.init()}});return}a.getScript("http://www.google.com/jsapi?key="+c.settings.apiKey).done(function(){c.init()}).fail(function(a,b,d){c.debug(d,1)})},getGeolocation:function(){var a=this,c=a.settings,d=a.$geodataElem,e=b.navigator.geolocation,f=a.googleMaps,g=a.google.loader,h=g.ClientLocation,i=null,j=null,k=null,l=null;h!=null&&(i=h.latitude,j=h.longitude),a.tCount||(k=b.setTimeout(function(){a.tCount++,a.getGeolocation()},500)),!a.tCount&&e?e.getCurrentPosition(function(c){var d=c.coords,e=d.latitude,g=d.longitude;if(c&&d!=null){a.html5Geo=!0,b.clearTimeout(k),l=new f.LatLng(e,g),a.ownLatLng=e+", "+g,a.updateOwnLocation(l),a.loopAddressLists(l);return}},function(b){a.geolocationError(b)},{maximumAge:c.maximumAge,timeout:c.timeout,enableHighAccuracy:c.enableHighAccuracy}):a.tCount<2&&!a.html5Geo&&typeof a.google=="object"&&g!=null&&h!=null&&(l=new f.LatLng(i,j),a.ownLatLng=i+", "+j,a.updateOwnLocation(l),a.loopAddressLists(l)),a.tCount>0&&h==null&&!a.html5Geo&&(a.tCount=0,a.resetElements(),c.debugMode&&a.debug("== Google API warning ==\nmessage: "+c.notFoundStr,2),d.length&&d.text(c.notFoundStr),a.$el.trigger("geolocator:fail"))},updateOwnLocation:function(a){var b=this,c=b.settings,d=b.$geodataElem,e=b.googleMaps,f=new e.Geocoder;f.geocode({latLng:a},function(a,e){var f="";e==="OK"?(d.length&&d.text(a[0].formatted_address),b.$el.trigger("geolocator:own-done")):(b.$el.trigger("geolocator:own-fail"),c.debugMode&&(e==="OVER_QUERY_LIMIT"?f="You are over your quota.":e==="ZERO_RESULTS"?f="Geocode was successful but returned no results.":e==="REQUEST_DENIED"?f="Your request was denied.":e==="INVALID_REQUEST"&&(f="The query (address or latlng) is missing."),b.debug("== Google Geocoding API error ==\nmessage: "+f,1)))})},loopAddressLists:function(b){var c=this,d=c.googleMaps,e=c.listLength,f=new d.DirectionsService;a.each(c.$lists,function(a,g){c.getDistances(a,g,e,d,f,b)})},getDistances:function(b,c,d,e,f,g){var h=this,i=h.settings,j=h.addressArr;j[b]=a(c).children(i.listElem).clone(!0).map(function(b,c){var d=a(c),f=d.find(i.geoAdrElem),g=null,h=null,j=(g=f.data("latitude"))&&(h=f.data("longitude"))?new e.LatLng(g,h):null;return{addresstxt:a.text(f.find(".street-address"))+", "+a.text(f.find(".postal-code"))+", "+a.text(f.find(".locality"))+" "+a.text(f.find(".region")),latLng:j,element:d,distance:null,endloc:null}}),a.each(j[b],function(a,b){var c=b.latLng||b.addresstxt;f.route({origin:g,destination:c,travelMode:e.DirectionsTravelMode.DRIVING},function(a,c){if(c==="OK"){var e=a.routes[0].legs[0],f=e.end_location;b.distance=e.distance.value,b.endloc=f.Ya+", "+f.Za}else b.distance=i.distanceUnknownStr,b.endloc=null;h.lCount++,h.lCount===d&&h.finishLocating()})})},finishLocating:function(){var a=this,b=a.addressArr,c=b.length;a.lCount=0;while(c--)a.updateAddresslist(c);b.length=0,a.resetElements(),a.$el.trigger("geolocator:done")},updateAddresslist:function(a){var b=this,c=b.settings,d=c.listElem,e=b.google.loader.ClientLocation,f=b.addressArr,g=f[a].length,h="",i=0,j=null,k=null,l=null,m=null,n=null;c.sorting&&g>1&&f[a].sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0}),j=b.ownLatLng||e.latitude+", "+e.longitude;for(;i<g;i++)l=f[a][i],m=l.element,n=m.find(c.mapsLinkElem),l.endloc&&(k="http://maps.google.com/maps?saddr="+j+"&daddr="+l.endloc,n.length?n.attr("href",k):m.append('<a href="'+k+'" class="'+c.mapsLinkElem.substring(1)+'">'+c.mapsLinkStr+"</a>")),m.find(c.distanceElem).text(b.formatDistance(l.distance)),h+=m.outerHTML();b.$lists.eq(a).html(h)},formatDistance:function(a){var b=1609.344,c=this.settings,d=" "+c.distanceBigStr,e=" miles";return a>b/10&&d===e?a=Math.round(a/b*10)/10+d:a>100&&d!==e?a=(a*.001).toFixed(1)+d:a=parseFloat(a)===a?a+" "+c.distanceSmallStr:c.distanceUnknownStr,a},resetElements:function(){var b=this,c=b.settings,d=b.$notificationElem,e=b.$recheckElem,f=b.$checkElem,g=c.notificationStyle;d.length&&d.is(":visible")&&(g==="fade"?d.fadeOut(300):g==="slide"?d.slideUp(300):d.hide()),e.length&&!e.is(":visible")&&(f.length&&f.is(":visible")&&f.unbind("click").hide(),b.$recheckElem.show().click(function(c){c.preventDefault(),a(this).unbind("click").hide(),b.prepare()}))},geolocationError:function(a){var b=this;b.settings.debugMode&&b.debug("== HTML5 Geolocation API warning ==\nmessage: "+a.message+"\ncode: "+a.code,2)},debug:function(a,c){var d=b.console;d&&(d.error&&c===1?d.error(a):d.warn&&c===2?d.warn(a):d.log&&d.log(a))}},a.fn.geolocator=function(b){return this.length?this.each(function(){var c=a.data(this,e);c?c.prepare():(b=a.extend({},f,b),a.data(this,e,new g(this,b)))}):this},a.fn.outerHTML=function(){return this.length?this[0].outerHTML||function(a){var b=c.createElement("div"),d;return b.appendChild(a.cloneNode(!0)),d=b.innerHTML,b=null,d}(this[0]):this}})(window.jQuery,window,window.document);