/*! jquery-geolocator - v1.0.4 - 2012-09-16
* http://krister.fi/jquery.geolocator/
* Copyright (c) 2012 Krister Kari; Licensed MIT */
(function(e,t,n,r){"use strict";function o(t,n){return this.settings=n,this.el=n.locationsElem||t,this.addressArr=[],this.$el=e(this.el),this.$recheckElem=e(n.recheckElem),this.$checkElem=e(n.checkElem),this.$notificationElem=e(n.notificationElem),this.$geodataElem=e(n.geodataElem),this.prepare(),this}var i="jquery-geolocator",s={manualCheck:!1,sorting:!0,debugMode:!1,enableHighAccuracy:!1,targetBlank:!1,timeout:6e3,maximumAge:6e4,apiKey:null,locationsElem:null,geodataElem:"#geodata",recheckElem:"#recheck",checkElem:"#check",notificationElem:".notification",distanceElem:".distance",geoAdrElem:".adr",mapsLinkElem:".maps-link",listParentElem:"ul",listElem:"li",notificationStyle:"show",distanceBigStr:"miles",distanceSmallStr:"meters",distanceUnknownStr:"unknown",notFoundStr:"Could not get your location",mapsLinkStr:"Show directions"};o.prototype={constructor:o,prepare:function(){var e=this,t=e.settings,n=e.$checkElem;e.$lists=e.$el.children(t.listParentElem),e.listLength=e.$lists.children(t.listElem).length,e.ownLatLng=null,e.tCount=0,e.lCount=0,e.html5Geo=!1,e.addressArr.length=0,t.manualCheck&&n.length?n.show().click(function(t){t.preventDefault(),e.init()}):e.init()},init:function(){var e=this,n=t.google,r=e.$notificationElem,i=e.$recheckElem,s=e.settings.notificationStyle;if(typeof n=="undefined"||typeof n.load=="undefined"||typeof n.maps=="undefined"){e.loadGoogleAPI();return}e.google=n,e.googleMaps=n.maps,r.length&&!r.is(":visible")&&(s==="fade"?r.fadeIn(300):r.show()),i.length&&i.is(":visible")&&i.unbind("click").hide(),e.getGeolocation()},loadGoogleAPI:function(){var n=this,r=t.google;if(typeof r!="undefined"&&typeof r.load!="undefined"&&typeof r.maps=="undefined"){r.load("maps","3",{other_params:"sensor=true",callback:function(){n.init()}});return}e.ajax({url:"http://www.google.com/jsapi?key="+n.settings.apiKey,dataType:"script",success:function(){n.init()},error:function(e,t,r){n.debug(r,1)}})},getGeolocation:function(){var e=this,n=e.settings,r=e.$geodataElem,i=t.navigator,s=e.googleMaps,o=e.google.loader,u=o.ClientLocation,a,f,l;u!=null&&(a=u.latitude,f=u.longitude),e.tCount||(l=t.setTimeout(function(){e.tCount++,e.getGeolocation()},500)),!e.tCount&&"geolocation"in i?i.geolocation.getCurrentPosition(function(n){var r=n.coords,i=r.latitude,o=r.longitude;if(n&&r!=null){e.html5Geo=!0,t.clearTimeout(l),e.ownLocation=new s.LatLng(i,o),e.ownLatLng=i+", "+o,e.updateOwnLocation(),e.loopAddressLists();return}},function(t){e.geolocationError(t)},{maximumAge:n.maximumAge,timeout:n.timeout,enableHighAccuracy:n.enableHighAccuracy}):e.tCount<2&&!e.html5Geo&&typeof e.google=="object"&&o!=null&&u!=null&&(t.clearTimeout(l),e.ownLocation=new s.LatLng(a,f),e.ownLatLng=a+", "+f,e.updateOwnLocation(),e.loopAddressLists()),e.tCount>0&&u==null&&!e.html5Geo&&(e.tCount=0,e.resetElements(),n.debugMode&&e.debug("== Google API warning ==\nmessage: "+n.notFoundStr,2),r.length&&r.text(n.notFoundStr),e.$el.trigger("geolocator:fail"))},updateOwnLocation:function(){var e=this,t=e.settings,n=e.$geodataElem,r=e.googleMaps,i=new r.Geocoder;i.geocode({latLng:e.ownLocation},function(r,i){var s="";i==="OK"?(n.length&&n.text(r[0].formatted_address),e.$el.trigger("geolocator:own-done")):(e.$el.trigger("geolocator:own-fail"),t.debugMode&&(i==="OVER_QUERY_LIMIT"?s="You are over your quota.":i==="ZERO_RESULTS"?s="Geocode was successful but returned no results.":i==="REQUEST_DENIED"?s="Your request was denied.":i==="INVALID_REQUEST"&&(s="The query (address or latlng) is missing."),e.debug("== Google Geocoding API error ==\nmessage: "+s,1)))})},loopAddressLists:function(){var e=this,t=0,n=e.$lists.length;for(;t<n;t++)e.getDistances(t,e.$lists[t])},getDistances:function(t,n){var r=this,i=r.settings,s=r.addressArr,o=0,u,a,f;s[t]=e(n).children(i.listElem).clone(!0).map(function(t,n){var s=e(n),o=s.find(i.geoAdrElem),u,a,f=(u=o.data("latitude"))&&(a=o.data("longitude"))?new r.googleMaps.LatLng(u,a):null;return{addresstxt:o.find(".street-address").text()+", "+o.find(".postal-code").text()+", "+o.find(".locality").text()+" "+o.find(".region").text()+", "+o.find(".country-name").text(),latLng:f,element:s,distance:null,endloc:null}}),u=s[t].length;for(;o<u;o++)a=s[t][o],f=a.latLng||a.addresstxt,r.getDistance(a,f)},getDistance:function(e,n){var r=this,i=this.settings,s=r.listLength,o=r.googleMaps,u=new o.DirectionsService;u.route({origin:r.ownLocation,destination:n,travelMode:o.DirectionsTravelMode.DRIVING},function(o,u){if(u==="OK"){var a=o.routes[0].legs[0],f=a.end_location,l="",c=0,h;for(h in f)f.hasOwnProperty(h)&&(l+=f[h],c||(l+=", "),c++);e.distance=a.distance.value,e.endloc=l,r.lCount++}else u==="OVER_QUERY_LIMIT"?t.setTimeout(function(){r.getDistance(e,n)},1e3):(e.distance=i.distanceUnknownStr,e.endloc=null,r.lCount++);r.lCount===s&&r.finishLocating()})},finishLocating:function(){var e=this,t=e.addressArr,n=t.length;e.lCount=0;while(n--)e.updateAddresslist(n);t.length=0,e.resetElements(),e.$el.trigger("geolocator:done")},updateAddresslist:function(e){var t=this,r=t.settings,i=t.google.loader.ClientLocation,s=t.addressArr,o=s[e].length,u="",a=0,f,l,c,h,p,d,v;r.sorting&&o>1&&s[e].sort(function(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}),f=t.ownLatLng||i.latitude+", "+i.longitude;for(;a<o;a++)c=s[e][a],h=c.element,p=h.find(r.mapsLinkElem),c.endloc&&(l="http://maps.google.com/maps?saddr="+f+"&daddr="+c.endloc,p.length?p[0].setAttribute("href",l):(d=n.createElement("a"),v=n.createTextNode(r.mapsLinkStr),d.appendChild(v),d.setAttribute("href",l),d.className=r.mapsLinkElem.substring(1),r.targetBlank&&d.setAttribute("target","_blank"),h[0].appendChild(d))),h.find(r.distanceElem).text(t.formatDistance(c.distance)),u+=h.outerHTML();t.$lists.eq(e).html(u)},formatDistance:function(e){var t=1609.344,n=this.settings,r=" "+n.distanceBigStr,i=" miles";return e>t/10&&r===i?e=Math.round(e/t*10)/10+r:e>100&&r!==i?e=(e*.001).toFixed(1)+r:e=parseFloat(e)===e?e+" "+n.distanceSmallStr:n.distanceUnknownStr,e},resetElements:function(){var t=this,n=t.settings,r=t.$notificationElem,i=t.$recheckElem,s=t.$checkElem,o=n.notificationStyle;r.length&&r.is(":visible")&&(o==="fade"?r.fadeOut(300):r.hide()),i.length&&!i.is(":visible")&&(s.length&&s.is(":visible")&&s.unbind("click").hide(),t.$recheckElem.show().click(function(n){n.preventDefault(),e(this).unbind("click").hide(),t.prepare()}))},geolocationError:function(e){var t=this;t.settings.debugMode&&t.debug("== HTML5 Geolocation API warning ==\nmessage: "+e.message+"\ncode: "+e.code,2)},debug:function(e,n){var r=t.console;r&&(r.error&&n===1?r.error(e):r.warn&&n===2?r.warn(e):r.log&&r.log(e))}},e.fn.geolocator=function(t){return this.length?this.each(function(){var n=e(this),r=n.data(i);r?r.prepare():(t=e.extend({},s,t),n.data(i,new o(this,t)))}):this},e.fn.outerHTML=function(){return this.length?this[0].outerHTML||function(e){var t=n.createElement("div"),r;return t.appendChild(e.cloneNode(!0)),r=t.innerHTML,t=null,r}(this[0]):this}})(window.jQuery||window.Zepto,window,window.document);