/*! jquery-geolocator - v1.0.4 - 2012-08-19
* http://krister.fi/jquery.geolocator/
* Copyright (c) 2012 Krister Kari; Licensed MIT */
(function(a,b,c,d){function g(b,c){return this.settings=c,this.el=c.locationsElem||b,this.addressArr=[],this.$el=a(this.el),this.$recheckElem=a(c.recheckElem),this.$checkElem=a(c.checkElem),this.$notificationElem=a(c.notificationElem),this.$geodataElem=a(c.geodataElem),this.prepare(),this}"use strict";var e="jquery-geolocator",f={manualCheck:!1,sorting:!0,debugMode:!1,enableHighAccuracy:!1,targetBlank:!1,timeout:6e3,maximumAge:6e4,apiKey:null,locationsElem:null,geodataElem:"#geodata",recheckElem:"#recheck",checkElem:"#check",notificationElem:".notification",distanceElem:".distance",geoAdrElem:".adr",mapsLinkElem:".maps-link",listParentElem:"ul",listElem:"li",notificationStyle:"show",distanceBigStr:"miles",distanceSmallStr:"meters",distanceUnknownStr:"unknown",notFoundStr:"Could not get your location",mapsLinkStr:"Show directions"};g.prototype={constructor:g,prepare:function(){var a=this,b=a.settings,c=a.$checkElem;a.$lists=a.$el.children(b.listParentElem),a.listLength=a.$lists.children(b.listElem).length,a.ownLatLng=null,a.tCount=0,a.lCount=0,a.html5Geo=!1,a.addressArr.length=0,b.manualCheck&&c.length?c.show().click(function(b){b.preventDefault(),a.init()}):a.init()},init:function(){var a=this,c=b.google,d=a.$notificationElem,e=a.$recheckElem,f=a.settings.notificationStyle;if(typeof c=="undefined"||typeof c.load=="undefined"||typeof c.maps=="undefined"){a.loadGoogleAPI();return}a.google=c,a.googleMaps=c.maps,d.length&&!d.is(":visible")&&(f==="fade"?d.fadeIn(300):d.show()),e.length&&e.is(":visible")&&e.unbind("click").hide(),a.getGeolocation()},loadGoogleAPI:function(){var c=this,d=b.google;if(typeof d!="undefined"&&typeof d.load!="undefined"&&typeof d.maps=="undefined"){d.load("maps","3",{other_params:"sensor=true",callback:function(){c.init()}});return}a.ajax({url:"http://www.google.com/jsapi?key="+c.settings.apiKey,dataType:"script",success:function(){c.init()},error:function(a,b,d){c.debug(d,1)}})},getGeolocation:function(){var a=this,c=a.settings,d=a.$geodataElem,e=b.navigator,f=a.googleMaps,g=a.google.loader,h=g.ClientLocation,i,j,k,l;h!=null&&(i=h.latitude,j=h.longitude),a.tCount||(k=b.setTimeout(function(){a.tCount++,a.getGeolocation()},500)),!a.tCount&&"geolocation"in e?e.geolocation.getCurrentPosition(function(c){var d=c.coords,e=d.latitude,g=d.longitude;if(c&&d!=null){a.html5Geo=!0,b.clearTimeout(k),a.ownLocation=new f.LatLng(e,g),a.ownLatLng=e+", "+g,a.updateOwnLocation(),a.loopAddressLists();return}},function(b){a.geolocationError(b)},{maximumAge:c.maximumAge,timeout:c.timeout,enableHighAccuracy:c.enableHighAccuracy}):a.tCount<2&&!a.html5Geo&&typeof a.google=="object"&&g!=null&&h!=null&&(b.clearTimeout(k),a.ownLocation=new f.LatLng(i,j),a.ownLatLng=i+", "+j,a.updateOwnLocation(),a.loopAddressLists()),a.tCount>0&&h==null&&!a.html5Geo&&(a.tCount=0,a.resetElements(),c.debugMode&&a.debug("== Google API warning ==\nmessage: "+c.notFoundStr,2),d.length&&d.text(c.notFoundStr),a.$el.trigger("geolocator:fail"))},updateOwnLocation:function(){var a=this,b=a.settings,c=a.$geodataElem,d=a.googleMaps,e=new d.Geocoder;e.geocode({latLng:a.ownLocation},function(d,e){var f="";e==="OK"?(c.length&&c.text(d[0].formatted_address),a.$el.trigger("geolocator:own-done")):(a.$el.trigger("geolocator:own-fail"),b.debugMode&&(e==="OVER_QUERY_LIMIT"?f="You are over your quota.":e==="ZERO_RESULTS"?f="Geocode was successful but returned no results.":e==="REQUEST_DENIED"?f="Your request was denied.":e==="INVALID_REQUEST"&&(f="The query (address or latlng) is missing."),a.debug("== Google Geocoding API error ==\nmessage: "+f,1)))})},loopAddressLists:function(){var a=this,b=0,c=a.$lists.length;for(;b<c;b++)a.getDistances(b,a.$lists[b])},getDistances:function(b,c){var d=this,e=d.settings,f=d.addressArr,g=0,h,i,j;f[b]=a(c).children(e.listElem).clone(!0).map(function(b,c){var f=a(c),g=f.find(e.geoAdrElem),h,i,j=(h=g.data("latitude"))&&(i=g.data("longitude"))?new d.googleMaps.LatLng(h,i):null;return{addresstxt:g.find(".street-address").text()+", "+g.find(".postal-code").text()+", "+g.find(".locality").text()+" "+g.find(".region").text()+", "+g.find(".country-name").text(),latLng:j,element:f,distance:null,endloc:null}}),h=f[b].length;for(;g<h;g++)i=f[b][g],j=i.latLng||i.addresstxt,d.getDistance(i,j)},getDistance:function(a,b){var c=this,d=this.settings,e=c.listLength,f=c.googleMaps,g=new f.DirectionsService;g.route({origin:c.ownLocation,destination:b,travelMode:f.DirectionsTravelMode.DRIVING},function(f,g){if(g==="OK"){var h=f.routes[0].legs[0],i=h.end_location,j="",k=0,l;for(l in i)i.hasOwnProperty(l)&&(j+=i[l],k||(j+=", "),k++);a.distance=h.distance.value,a.endloc=j,c.lCount++}else g==="OVER_QUERY_LIMIT"?setTimeout(function(){c.getDistance(a,b)},1e3):(a.distance=d.distanceUnknownStr,a.endloc=null,c.lCount++);c.lCount===e&&c.finishLocating()})},finishLocating:function(){var a=this,b=a.addressArr,c=b.length;a.lCount=0;while(c--)a.updateAddresslist(c);b.length=0,a.resetElements(),a.$el.trigger("geolocator:done")},updateAddresslist:function(a){var b=this,d=b.settings,e=d.listElem,f=b.google.loader.ClientLocation,g=b.addressArr,h=g[a].length,i="",j=0,k,l,m,n,o;d.sorting&&h>1&&g[a].sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0}),k=b.ownLatLng||f.latitude+", "+f.longitude;for(;j<h;j++){m=g[a][j],n=m.element,o=n.find(d.mapsLinkElem);if(m.endloc){l="http://maps.google.com/maps?saddr="+k+"&daddr="+m.endloc;if(!o.length){var p=c.createElement("a"),q=c.createTextNode(d.mapsLinkStr);p.appendChild(q),p.setAttribute("href",l),p.className=d.mapsLinkElem.substring(1),d.targetBlank&&p.setAttribute("target","_blank"),n[0].appendChild(p)}else o[0].setAttribute("href",l)}n.find(d.distanceElem).text(b.formatDistance(m.distance)),i+=n.outerHTML()}b.$lists.eq(a).html(i)},formatDistance:function(a){var b=1609.344,c=this.settings,d=" "+c.distanceBigStr,e=" miles";return a>b/10&&d===e?a=Math.round(a/b*10)/10+d:a>100&&d!==e?a=(a*.001).toFixed(1)+d:a=parseFloat(a)===a?a+" "+c.distanceSmallStr:c.distanceUnknownStr,a},resetElements:function(){var b=this,c=b.settings,d=b.$notificationElem,e=b.$recheckElem,f=b.$checkElem,g=c.notificationStyle;d.length&&d.is(":visible")&&(g==="fade"?d.fadeOut(300):d.hide()),e.length&&!e.is(":visible")&&(f.length&&f.is(":visible")&&f.unbind("click").hide(),b.$recheckElem.show().click(function(c){c.preventDefault(),a(this).unbind("click").hide(),b.prepare()}))},geolocationError:function(a){var b=this;b.settings.debugMode&&b.debug("== HTML5 Geolocation API warning ==\nmessage: "+a.message+"\ncode: "+a.code,2)},debug:function(a,c){var d=b.console;d&&(d.error&&c===1?d.error(a):d.warn&&c===2?d.warn(a):d.log&&d.log(a))}},a.fn.geolocator=function(b){return this.length?this.each(function(){var c=a(this),d=c.data(e);d?d.prepare():(b=a.extend({},f,b),c.data(e,new g(this,b)))}):this},a.fn.outerHTML=function(){return this.length?this[0].outerHTML||function(a){var b=c.createElement("div"),d;return b.appendChild(a.cloneNode(!0)),d=b.innerHTML,b=null,d}(this[0]):this}})(window.jQuery||window.Zepto,window,window.document);