/*! jQuery Geolocator v1.0.2 | http://github.com/kristerkari/jQuery-Geolocator */
(function(d,k,o){function m(a,b){this.settings=b;this.el=b.locationsElem||a;this.addressArr=[];this.$el=d(this.el);this.$recheckElem=d(b.recheckElem);this.$checkElem=d(b.checkElem);this.$notificationElem=d(b.notificationElem);this.$geodataElem=d(b.geodataElem);this.prepare();return this}var q={manualCheck:!1,sorting:!0,debugMode:!1,enableHighAccuracy:!1,targetBlank:!1,timeout:6E3,maximumAge:6E4,apiKey:null,locationsElem:null,geodataElem:"#geodata",recheckElem:"#recheck",checkElem:"#check",notificationElem:".notification",
distanceElem:".distance",geoAdrElem:".adr",mapsLinkElem:".maps-link",listParentElem:"ul",listElem:"li",notificationStyle:"show",distanceBigStr:"miles",distanceSmallStr:"meters",distanceUnknownStr:"unknown",notFoundStr:"Could not get your location",mapsLinkStr:"Show directions"};m.prototype={constructor:m,prepare:function(){var a=this,b=a.settings,c=a.$checkElem;a.$lists=a.$el.children(b.listParentElem);a.listLength=a.$lists.children(b.listElem).length;a.ownLatLng=null;a.tCount=0;a.lCount=0;a.html5Geo=
!1;a.addressArr.length=0;b.manualCheck&&c.length?c.show().click(function(b){b.preventDefault();a.init()}):a.init()},init:function(){var a=k.google,b=this.$notificationElem,c=this.$recheckElem,i=this.settings.notificationStyle;"undefined"===typeof a||"undefined"===typeof a.load||"undefined"===typeof a.maps?this.loadGoogleAPI():(this.google=a,this.googleMaps=a.maps,b.length&&!b.is(":visible")&&("fade"===i?b.fadeIn(300):"slide"===i?b.slideDown(300):b.show()),c.length&&c.is(":visible")&&c.unbind("click").hide(),
this.getGeolocation())},loadGoogleAPI:function(){var a=this,b=k.google;"undefined"!==typeof b&&"undefined"!==typeof b.load&&"undefined"===typeof b.maps?b.load("maps","3",{other_params:"sensor=true",callback:function(){a.init()}}):d.getScript("http://www.google.com/jsapi?key="+a.settings.apiKey).done(function(){a.init()}).fail(function(b,i,f){a.debug(f,1)})},getGeolocation:function(){var a=this,b=a.settings,c=a.$geodataElem,i=k.navigator,f=a.googleMaps,e=a.google.loader,d=e.ClientLocation,g,h,l;null!=
d&&(g=d.latitude,h=d.longitude);a.tCount||(l=k.setTimeout(function(){a.tCount++;a.getGeolocation()},500));!a.tCount&&"geolocation"in i?i.geolocation.getCurrentPosition(function(b){var c=b.coords,d=c.latitude,i=c.longitude;if(b&&c!=null){a.html5Geo=true;k.clearTimeout(l);a.ownLocation=new f.LatLng(d,i);a.ownLatLng=d+", "+i;a.updateOwnLocation();a.loopAddressLists()}},function(b){a.geolocationError(b)},{maximumAge:b.maximumAge,timeout:b.timeout,enableHighAccuracy:b.enableHighAccuracy}):2>a.tCount&&
!a.html5Geo&&("object"===typeof a.google&&null!=e&&null!=d)&&(k.clearTimeout(l),a.ownLocation=new f.LatLng(g,h),a.ownLatLng=g+", "+h,a.updateOwnLocation(),a.loopAddressLists());0<a.tCount&&(null==d&&!a.html5Geo)&&(a.tCount=0,a.resetElements(),b.debugMode&&a.debug("== Google API warning ==\nmessage: "+b.notFoundStr,2),c.length&&c.text(b.notFoundStr),a.$el.trigger("geolocator:fail"))},updateOwnLocation:function(){var a=this,b=a.settings,c=a.$geodataElem;(new a.googleMaps.Geocoder).geocode({latLng:a.ownLocation},
function(d,f){var e="";"OK"===f?(c.length&&c.text(d[0].formatted_address),a.$el.trigger("geolocator:own-done")):(a.$el.trigger("geolocator:own-fail"),b.debugMode&&("OVER_QUERY_LIMIT"===f?e="You are over your quota.":"ZERO_RESULTS"===f?e="Geocode was successful but returned no results.":"REQUEST_DENIED"===f?e="Your request was denied.":"INVALID_REQUEST"===f&&(e="The query (address or latlng) is missing."),a.debug("== Google Geocoding API error ==\nmessage: "+e,1)))})},loopAddressLists:function(){for(var a=
0,b=this.$lists.length;a<b;a++)this.getDistances(a,this.$lists[a])},getDistances:function(a,b){var c=this,i=c.settings,f=c.addressArr,e=0,n,g,h;f[a]=d(b).children(i.listElem).clone(!0).map(function(a,b){var f=d(b),e=f.find(i.geoAdrElem),g,h,n=(g=e.data("latitude"))&&(h=e.data("longitude"))?new c.googleMaps.LatLng(g,h):null;return{addresstxt:d.text(e.find(".street-address"))+", "+d.text(e.find(".postal-code"))+", "+d.text(e.find(".locality"))+" "+d.text(e.find(".region"))+", "+d.text(e.find(".country-name")),
latLng:n,element:f,distance:null,endloc:null}});for(n=f[a].length;e<n;e++)g=f[a][e],h=g.latLng||g.addresstxt,c.getDistance(g,h)},getDistance:function(a,b){var c=this,d=this.settings,f=c.listLength,e=c.googleMaps;(new e.DirectionsService).route({origin:c.ownLocation,destination:b,travelMode:e.DirectionsTravelMode.DRIVING},function(e,g){if("OK"===g){var h=e.routes[0].legs[0],l=h.end_location,j="",k=0,p;for(p in l)l.hasOwnProperty(p)&&(j+=l[p],k||(j+=", "),k++);a.distance=h.distance.value;a.endloc=j;
c.lCount++}else"OVER_QUERY_LIMIT"===g?setTimeout(function(){c.getDistance(a,b)},1E3):(a.distance=d.distanceUnknownStr,a.endloc=null,c.lCount++);c.lCount===f&&c.finishLocating()})},finishLocating:function(){var a=this.addressArr,b=a.length;for(this.lCount=0;b--;)this.updateAddresslist(b);a.length=0;this.resetElements();this.$el.trigger("geolocator:done")},updateAddresslist:function(a){var b=this.settings,c=this.google.loader.ClientLocation,d=this.addressArr,f=d[a].length,e="",k=0,g,h,l,j;b.sorting&&
1<f&&d[a].sort(function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0});for(c=this.ownLatLng||c.latitude+", "+c.longitude;k<f;k++){h=d[a][k];l=h.element;j=l.find(b.mapsLinkElem);if(h.endloc)if(g="http://maps.google.com/maps?saddr="+c+"&daddr="+h.endloc,j.length)j[0].setAttribute("href",g);else{j=o.createElement("a");var m=o.createTextNode(b.mapsLinkStr);j.appendChild(m);j.setAttribute("href",g);j.className=b.mapsLinkElem.substring(1);b.targetBlank&&j.setAttribute("target","_blank");
l[0].appendChild(j)}l.find(b.distanceElem).text(this.formatDistance(h.distance));e+=l.outerHTML()}this.$lists.eq(a).html(e)},formatDistance:function(a){var b=this.settings,c=" "+b.distanceBigStr;return a=160.9344<a&&" miles"===c?Math.round(10*(a/1609.344))/10+c:100<a&&" miles"!==c?(0.001*a).toFixed(1)+c:parseFloat(a)===a?a+" "+b.distanceSmallStr:b.distanceUnknownStr},resetElements:function(){var a=this,b=a.$notificationElem,c=a.$recheckElem,i=a.$checkElem,f=a.settings.notificationStyle;b.length&&
b.is(":visible")&&("fade"===f?b.fadeOut(300):"slide"===f?b.slideUp(300):b.hide());c.length&&!c.is(":visible")&&(i.length&&i.is(":visible")&&i.unbind("click").hide(),a.$recheckElem.show().click(function(b){b.preventDefault();d(this).unbind("click").hide();a.prepare()}))},geolocationError:function(a){this.settings.debugMode&&this.debug("== HTML5 Geolocation API warning ==\nmessage: "+a.message+"\ncode: "+a.code,2)},debug:function(a,b){var c=k.console;c&&(c.error&&1===b?c.error(a):c.warn&&2===b?c.warn(a):
c.log&&c.log(a))}};d.fn.geolocator=function(a){return!this.length?this:this.each(function(){var b=d.data(this,"jquery-geolocator");b?b.prepare():(a=d.extend({},q,a),d.data(this,"jquery-geolocator",new m(this,a)))})};d.fn.outerHTML=function(){var a;if(this.length){if(!(a=this[0].outerHTML)){a=this[0];var b=o.createElement("div");b.appendChild(a.cloneNode(!0));a=b.innerHTML}}else a=this;return a}})(window.jQuery,window,window.document);